---

image: node:10-alpine

stages:
  - Install
  - Build
  - Test

Install:
  stage: Install
  script:
    - yarn
    - yarn run lerna bootstrap
  artifacts:
    expire_in: "1 day"
    paths:
      - node_modules
      - packages/contrib/node_modules

Build:
  stage: Build
  script:
    # Generate the .env file:
    - yarn setup --env-only
    # Start Docker Compose & a local server instance (in the background):
    - bash scripts/prod/start.sh
  artifacts:
    expire_in: "1 day"
    paths:
      - node_modules
      - packages/contrib/node_modules

Unit Tests:
  stage: Test
  script:
    - yarn test -- --stream -- --coverage
  after_script:
    - npx codecov

E2E Tests:
  stage: Test
  script:
    - yarn test:e2e
